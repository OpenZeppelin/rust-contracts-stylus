name: check-import
# This workflow checks that developers can import the contracts and crypto library.
permissions:
  contents: read
on:
  push:
    branches: [main, v*]
  pull_request:
concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true
env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1
jobs:
  check-import:
    name: Check Import
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            templates/crypto-erc20/target/
          key: ${{ runner.os }}-cargo-stylus-${{ hashFiles('templates/crypto-erc20/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-stylus-

      - name: Install rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          rustflags: ""
          cache: false # We handle caching manually above

      - name: Install cargo-stylus
        run: cargo install --locked cargo-stylus@0.6.3

      - name: Replace path dependencies with git dependencies
        working-directory: templates/crypto-erc20
        run: |
          # Get current commit SHA
          COMMIT_SHA=$(git rev-parse HEAD)
          echo "Using commit SHA: $COMMIT_SHA"

          # Replace OpenZeppelin path dependencies with git references
          sed -i \
            -e "s|path = \"../../lib/crypto\"|git = \"https://github.com/OpenZeppelin/rust-contracts-stylus.git\", rev = \"$COMMIT_SHA\"|g" \
            -e "s|path = \"../../contracts\"|git = \"https://github.com/OpenZeppelin/rust-contracts-stylus.git\", rev = \"$COMMIT_SHA\"|g" \
            Cargo.toml

          # Verify changes and show relevant dependencies
          echo "=== Modified dependencies ==="
          grep -E "(openzeppelin|git =|rev =)" Cargo.toml | head -10

      - name: Update lockfile
        working-directory: templates/crypto-erc20
        run: cargo update --verbose

      - name: Run tests
        working-directory: templates/crypto-erc20
        run: cargo test --verbose

      - name: Build and check contract
        working-directory: templates/crypto-erc20
        run: cargo stylus check -e=https://sepolia-rollup.arbitrum.io/rpc

      - name: Export ABI
        working-directory: templates/crypto-erc20
        run: |
          cargo stylus export-abi
          echo "=== Generated ABI files ==="
          ls -la *.json || echo "No ABI files found"
